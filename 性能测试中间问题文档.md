# 性能测试中间问题文档

标签（空格分隔）： istio 性能测试

---




|环境  |应用|vCPU    |线程数 |连接数|测试时间|平均延迟|90延迟 |99延迟  |最大延迟 |  QPS  | CPU使用率|policy|telemetry|pilot|proxy(Envoy)|
|:----:|:----:|:----:  |:----: |:----:|:----:  | :----: |:----: | :----: | :----:  | :----:|:----:|:----:|:----:|:----:|:----:|
|K8S   |Nginx|2*2vCPU |4      |12    |90s     |1.054ms|1.486ms |3.166ms|73.924ms |11813|60.8|
|NoMixer|Nginx|2*2vCPU |2|10|120s|3.19ms|4.71ms|9.625ms|160.58ms |3259|62.5|||0.016|1.0205|
|ISTIO|Nginx|2*2vCPU |2|10|120s|7.36ms|16.20ms|35.16ms|152.39ms |1674|55.5|0.0045|0.8525|0.0115|0.6255|
|K8S|Nginx|4*2vCPU |4|32|120s|1.65ms|2.06ms|4.85ms|298.5ms |20094|60.75|||||
|NoMixer|Nginx|4*2vCPU |4|64|120s|12.82ms|22.95ms|47.10ms|287ms |5484|47.16|||0.037|1.912|
|Istio|Nginx|4*2vCPU |4|32|120s|14.18ms|36.89ms|77.78ms|236.17ms |3455|58.58|0.01|1.87|0.01|1.46|

|环境|vCPU|CPU1|CPU2|CPU3|CPU4|CPU平均使用|QPS|
|:----:|:----:|:----:|:----:|:----:|:----:|:----:|:----:|
|Istio|2*2vCPU|21.25|89.75|||55.5|1647|
|NoMixer|2*2vCPU|45|80|||62.5|3259|
|Istio|4*2vCPU|49|83|26|75|58.5|3455|
|NoMixer|4*2vCPU|30|98|34|27|47.16|5484|

>备注：
控制平面服务的Pod自动部署在了EKS集群的`WorkNodes`中，例如`Mixer`组件`istio-telemetry`、`istio-policy`,`Pilot`组件`istio-pilot`，网关服务组件`istio-ingressgateway`，而不是单独的部署在一个性能机枪
在目前的测试环境下，`istio-policy`和`istio-pilot`消耗`CPU`极小，具体可看上表。而`istio-telemetry`和`istio-ingressgateway`消耗CPU极大。
由于部署`istio-telemetry`和`istio-ingressgateway`服务Pod的Node节点，同时承担控制平面任务和工作节点任务，在数据平面工作量相近的情况下，该节点会快速达到CPU阈值，而其他的Node CPU使用程度还很低，完全没有得到充分使用。
在这种情况下，限制性能的已不是节点的数量多少，而是控制平面所在节点的性能。
例子：
在`NoMixer`，`4*2vCPU`下，`ingressgateway`消耗CPU为`1.435vCPU`。而单个节点的CPU总性能为2vCPU，

另外的一组数据：
|环境|vCPU|线程数|连接数|CPU1|CPU2|CPU3|CPU4|CPU平均使用|QPS|ingressgateway|proxy|
|:----:|:----:|:----:|:----:|:----:|:----:|:----:|:----:|
|NoMixer|4*2vCPU|4|64|26|98|36|28|47.75|5550|1.435|1.881|
|NoMixer|4*2vCPU|4|64|27|99|35|29|47.5|5550|1.49|1.956|
|NoMixer|4*2vCPU|4|64|92|93|45|95|81.25|9562|3.105|3.867|
|NoMixer|4*2vCPU|4|64|94|75|42|96|76.75|8924|1.435|3.603|

>通过这四组数据的对比可以看到，ingressgateway占用的CPU额度升高，CPU使用率顺势提高，经排查，发现在这两次压测中，Istio自动对ingressgateway的Pod数量进行了改变，从一个提高到了五个，分布在三个节点中，导致这三个CPU的使用率增加，相应QPS提高。 
但是在同样压测条件下上面两组数据没有做出相应的改变。
